name: Build OpenWrt Firmware

on:
  workflow_dispatch:
  push:
    paths:
      - 'Config/**'
      - 'Scripts/**'
      - 'diy-part*.sh'
      - '.github/workflows/openwrt-builder.yml'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Initialize environment
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget

    - name: Clone OpenWrt source
      run: |
        git clone https://github.com/openwrt/openwrt.git openwrt
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Copy builder.config
      run: |
        cd openwrt
        cp ../Config/builder.config .config

    - name: Run diy-part1.sh
      run: |
        chmod +x diy-part1.sh
        ./diy-part1.sh

    - name: Run diy-part2.sh
      run: |
        chmod +x diy-part2.sh
        ./diy-part2.sh

    # -----------------------------------------
    #  ⭐ 新增的调试步骤：编译前显示 feeds/package 状态
    # -----------------------------------------
    - name: Debug: Show feeds & package structure BEFORE compile
      run: |
        echo "=== DEBUG: Entering openwrt ==="
        cd openwrt

        echo "=== feeds.conf.default ==="
        cat feeds.conf.default || true

        echo "=== feeds/ directory ==="
        ls -la feeds || true

        echo "=== package/ directory ==="
        ls -la package || true

        echo "=== Search for qca / nss / kmod-qca ==="
        grep -R --line-number --exclude-dir=.git -e "qca" -e "nss" -e "kmod-qca" feeds package 2>/dev/null || true

        echo "=== List candidate dirs ==="
        find package feeds -maxdepth 4 -type d -iname "*qca*" -o -iname "*nss*" -print || true
    # -----------------------------------------

    - name: Compile the firmware
      run: |
        cd openwrt
        make defconfig
        make -j$(nproc) V=s

    - name: Upload firmware
      uses: actions/upload-artifact@v3
      with:
        name: OpenWrt-firmware
        path: openwrt/bin/targets
