name: OpenWrt Build (minimal-safe, VIKINGYFY/immortalwrt main)

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'Config/**'
      - 'Scripts/**'
      - 'diy-part*.sh'
      - '.github/workflows/openwrt-builder.yml'

env:
  SOURCE_REPO: https://github.com/VIKINGYFY/immortalwrt.git
  SOURCE_BRANCH: main
  SOURCE_DIR: openwrt

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Checkout repo (this contains builder.config and diy scripts)
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Install minimal system deps
      run: |
        sudo apt-get update -y
        sudo apt-get install -y build-essential git wget unzip curl \
          libncurses5-dev libssl-dev python3-distutils rsync zlib1g-dev file

    - name: Clone target source (preserve your source & branch)
      run: |
        echo "Cloning ${{ env.SOURCE_REPO }} branch ${{ env.SOURCE_BRANCH }} -> ${{ env.SOURCE_DIR }}"
        rm -rf "${{ env.SOURCE_DIR }}" || true
        git clone --depth=1 --branch "${{ env.SOURCE_BRANCH }}" "${{ env.SOURCE_REPO }}" "${{ env.SOURCE_DIR }}" || git clone --depth=1 "${{ env.SOURCE_REPO }}" "${{ env.SOURCE_DIR }}"
        cd "${{ env.SOURCE_DIR }}"
        ./scripts/feeds update -a || true
        ./scripts/feeds install -a || true

    - name: Apply builder.config & run your diy-part scripts (no modification)
      run: |
        cd "${{ env.SOURCE_DIR }}"

        # copy builder.config from this repository (if present) â€” do not overwrite upstream files
        if [ -f ../Config/builder.config ]; then
          cp -vf ../Config/builder.config .config || true
        elif [ -f ../builder.config ]; then
          cp -vf ../builder.config .config || true
        fi

        # run diy-part1.sh and diy-part2.sh from repo root if they exist
        if [ -f ../diy-part1.sh ]; then
          chmod +x ../diy-part1.sh || true
          ../diy-part1.sh || true
        fi
        if [ -f ../diy-part2.sh ]; then
          chmod +x ../diy-part2.sh || true
          ../diy-part2.sh || true
        fi

    # ------------------ Minimal, safe fixes (non-destructive) ------------------
    - name: Ensure nss/viking feeds exist (append-only)
      run: |
        cd "${{ env.SOURCE_DIR }}"
        touch feeds.conf.default
        if ! grep -q "nss_packages" feeds.conf.default 2>/dev/null; then
          echo "src-git nss_packages https://github.com/openwrt/nss_packages.git" >> feeds.conf.default
        fi
        if ! grep -q "viking_packages" feeds.conf.default 2>/dev/null; then
          echo "src-git viking_packages https://github.com/VIKINGYFY/packages.git" >> feeds.conf.default
        fi
        ./scripts/feeds update -i || true
        ./scripts/feeds install -a -f || true

    - name: Try to fetch kmod-qca candidates if missing (won't overwrite)
      run: |
        cd "${{ env.SOURCE_DIR }}"
        # only act if the expected dir truly missing
        if ! find package -maxdepth 2 -type d -name "kmod-qca-nss-drv" | grep -q .; then
          TMPDIR=$(mktemp -d)
          git clone --depth=1 https://github.com/openwrt/nss_packages.git "$TMPDIR/nss" || true
          git clone --depth=1 https://github.com/VIKINGYFY/packages.git "$TMPDIR/viking" || true
          mkdir -p package
          # copy candidate dirs but do NOT overwrite existing package dirs
          find "$TMPDIR" -maxdepth 4 -type d -iname "*qca*" -o -iname "*nss*" -print 2>/dev/null | while read d; do
            base=$(basename "$d")
            if [ ! -d "package/$base" ]; then
              echo "Copying candidate $base -> package/$base"
              cp -a "$d" "package/$base" || true
            else
              echo "package/$base exists; skip"
            fi
          done
          rm -rf "$TMPDIR" || true
        else
          echo "kmod-qca-nss-drv already present; no fetch needed"
        fi
        ./scripts/feeds install -a -f || true

    - name: Debug (short): show feeds.conf.default and package list
      run: |
        cd "${{ env.SOURCE_DIR }}"
        echo "=== feeds.conf.default (head) ==="
        sed -n '1,200p' feeds.conf.default || true
        echo "=== top-level package dirs ==="
        ls -la package || true
        echo "=== find qca/nss candidates ==="
        find package feeds -maxdepth 4 -type d -iname "*qca*" -o -iname "*nss*" -print || true
    # ------------------ End minimal fixes ------------------

    - name: Build OpenWrt (preserve your build logic)
      run: |
        cd "${{ env.SOURCE_DIR }}"
        if [ -f .config ]; then
          echo ".config found, running make defconfig"
          make defconfig || true
        else
          echo "No .config; running make defconfig"
          make defconfig || true
        fi
        make -j$(nproc) V=s

    - name: Upload artifacts (always)
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: openwrt_build_artifacts
        path: ${{ env.SOURCE_DIR }}/bin/targets
